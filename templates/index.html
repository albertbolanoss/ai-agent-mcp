<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MCP Chat Web</title>
  <style>
    :root {
      --bg: #0c1224;
      --panel: #0f172a;
      --panel-2: #121c32;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --accent: #22d3ee;
      --accent-2: #10b981;
      --error: #f87171;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
      --radius: 16px;
      --font: "Space Grotesk", "DM Sans", "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font);
      background: radial-gradient(circle at 15% 20%, rgba(34, 211, 238, 0.08), transparent 30%),
                  radial-gradient(circle at 85% 10%, rgba(16, 185, 129, 0.08), transparent 28%),
                  linear-gradient(135deg, #0a0f1f, #0d1428 55%, #0a1021);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 18px 48px;
    }

    .page {
      max-width: 1220px;
      margin: 0 auto;
      position: relative;
    }

    .hero {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }

    .hero h1 {
      margin: 0 0 6px;
      font-size: 28px;
      letter-spacing: -0.4px;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      max-width: 640px;
      line-height: 1.5;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      color: var(--text);
      font-size: 13px;
    }

    .pill small { color: var(--muted); }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    @media (max-width: 980px) {
      .hero { flex-direction: column; }
      .grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .panel::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(34, 211, 238, 0.08), rgba(16, 185, 129, 0.08));
      opacity: 0.04;
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .panel-title {
      margin: 0;
      font-size: 18px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text);
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .tag.info { color: var(--accent); }
    .tag.success { color: var(--accent-2); }
    .tag.error { color: var(--error); }

    .message-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .bubble {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .bubble.user {
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.16), rgba(34, 211, 238, 0.05));
      border-color: rgba(34, 211, 238, 0.25);
    }

    .bubble.assistant {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.05));
      border-color: rgba(16, 185, 129, 0.22);
    }

    .bubble-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }

    .bubble p {
      margin: 0;
      white-space: pre-wrap;
      line-height: 1.5;
      color: var(--text);
    }

    .composer {
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      padding-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
    }

    textarea:focus, input:focus {
      outline: 2px solid rgba(34, 211, 238, 0.6);
      outline-offset: 1px;
    }

    .inputs-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 640px) {
      .inputs-row { grid-template-columns: 1fr; }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 13px;
      color: var(--muted);
    }

    .field input {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 14px;
    }

    .actions {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      color: #03101a;
      background: linear-gradient(135deg, var(--accent), #60a5fa);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      box-shadow: 0 10px 30px rgba(34, 211, 238, 0.28);
      min-width: 120px;
    }

    .btn:active { transform: translateY(1px) scale(0.995); }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .intent-card {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
    }

    .stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat label {
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 0.2px;
    }

    .stat strong { font-size: 16px; color: var(--text); }

    .raw-block {
      background: #0a0f1f;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 12px;
      max-height: 360px;
      overflow: auto;
      font-family: "JetBrains Mono", "SFMono-Regular", "Consolas", monospace;
      font-size: 13px;
      line-height: 1.5;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 6px rgba(255, 255, 255, 0.05);
    }

    .status-dot.live { background: var(--accent); box-shadow: 0 0 0 6px rgba(34, 211, 238, 0.1); }
    .status-dot.idle { background: var(--muted); }
    .status-dot.error { background: var(--error); box-shadow: 0 0 0 6px rgba(248, 113, 113, 0.12); }
  </style>
</head>
<body>
  <div class="page">
    <header class="hero">
      <div>
        <h1>MCP Chat Web</h1>
        <p>Interfaz ligera para el endpoint de streaming /chat/stream. La API responde igual; aqui solo cambiamos el envoltorio visual para que la lectura sea mas clara y estetica.</p>
      </div>
      <div class="pill">
        <span class="status-dot idle" id="status-dot"></span>
        <span id="status-text">Esperando mensaje</span>
      </div>
    </header>

    <section class="grid">
      <article class="panel">
        <div class="panel-inner">
          <div class="panel-header">
            <h2 class="panel-title">Conversacion</h2>
            <span class="tag info">Streaming SSE</span>
          </div>
          <div id="messages" class="message-list"></div>
          <div class="composer">
            <textarea id="input" placeholder="Escribe tu mensaje o la solicitud de traduccion..."></textarea>
            <div class="inputs-row">
              <div class="field">
                <label for="session">Session ID (opcional)</label>
                <input id="session" placeholder="p.ej. demo-123" />
              </div>
            </div>
            <div class="actions">
              <div></div>
              <button class="btn" id="send-btn">Enviar</button>
            </div>
          </div>
        </div>
      </article>

      <article class="panel">
        <div class="panel-inner">
          <div class="panel-header">
            <h2 class="panel-title">Respuesta de la API</h2>
          </div>

          <div class="intent-card" id="intent-card">
            <div class="stat">
              <label>Tool</label>
              <strong id="stat-tool">-</strong>
            </div>
            <div class="stat">
              <label>isCompleted</label>
              <strong id="stat-completed">-</strong>
            </div>
            <div class="stat">
              <label>Reply</label>
              <strong id="stat-reply">-</strong>
            </div>
          </div>

          <div class="raw-block" aria-live="polite">
            <pre id="raw-json">Esperando mensaje...</pre>
          </div>
        </div>
      </article>
    </section>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sessionEl = document.getElementById('session');
    const sendBtn = document.getElementById('send-btn');
    const rawJsonEl = document.getElementById('raw-json');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const statTool = document.getElementById('stat-tool');
    const statCompleted = document.getElementById('stat-completed');
    const statReply = document.getElementById('stat-reply');

    const conversation = [];

    function setStatus(label, tone = 'idle') {
      statusText.textContent = label;
      statusDot.className = `status-dot ${tone}`;
    }

    function updateIntentCard(payload) {
      if (!payload || typeof payload !== 'object') return;
      statTool.textContent = payload.tool ?? '-';
      statCompleted.textContent = payload.isCompleted ?? '-';
      statReply.textContent = payload.reply ? payload.reply.slice(0, 120) : '-';

    }

    function updateRaw(payload) {
      rawJsonEl.textContent = JSON.stringify(payload, null, 2);
    }

    function appendMessage(role, text) {
      const wrapper = document.createElement('div');
      const bubble = document.createElement('article');
      const meta = document.createElement('div');
      const body = document.createElement('p');

      wrapper.className = 'bubble ' + role;
      meta.className = 'bubble-meta';
      meta.innerHTML = `<span>${role === 'user' ? 'Tu' : 'Asistente'}</span><span>${new Date().toLocaleTimeString()}</span>`;
      body.textContent = text;

      bubble.appendChild(meta);
      bubble.appendChild(body);
      wrapper.appendChild(bubble);
      messagesEl.appendChild(wrapper);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return body;
    }

    async function send() {
      const content = inputEl.value.trim();
      if (!content) return;

      conversation.push({ role: 'user', content });
      appendMessage('user', content);
      inputEl.value = '';
      setStatus('Esperando respuesta...', 'live');
      sendBtn.disabled = true;

      const payload = {
        messages: conversation,
        session_id: sessionEl.value.trim() || null,
      };

      const assistantBody = appendMessage('assistant', '...');
      let buffer = '';
      let assembled = '';
      let finalReply = '';

      try {
        const res = await fetch('/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          const events = buffer.split('\n\n');
          buffer = events.pop() || '';

          for (const evt of events) {
            if (!evt.startsWith('data:')) continue;
            const jsonStr = evt.replace(/^data:\s*/, '').trim();
            if (!jsonStr) continue;

            let payloadEvent;
            try {
              payloadEvent = JSON.parse(jsonStr);
            } catch (err) {
              continue;
            }

            updateRaw(payloadEvent);

            if (payloadEvent.type === 'start') {
              setStatus(`Usando tool: ${payloadEvent.tool || 'llm_chat'}`, 'live');
            }

            if (payloadEvent.type === 'token') {
              assembled += payloadEvent.delta || '';
            }

            if (payloadEvent.type === 'router_reply') {
              assembled = payloadEvent.reply || 'Faltan datos para completar la peticion.';
            }

            if (payloadEvent.type === 'complete') {
              assembled = payloadEvent.reply || assembled;
              finalReply = assembled;
              setStatus('Respuesta completada', 'idle');
            }

            if (payloadEvent.type === 'error') {
              assembled = payloadEvent.message || 'Error inesperado.';
              setStatus('Error al invocar la herramienta', 'error');
            }

            assistantBody.textContent = assembled || '...';
            messagesEl.scrollTop = messagesEl.scrollHeight;
            updateIntentCard(payloadEvent);
          }
        }
      } catch (err) {
        assembled = `[stream error] ${err}`;
        assistantBody.textContent = assembled;
        setStatus('Error de red', 'error');
      } finally {
        if (finalReply || assembled) {
          conversation.push({ role: 'assistant', content: finalReply || assembled });
        }
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' && (ev.metaKey || ev.ctrlKey)) {
        ev.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>
